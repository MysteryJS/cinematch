<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quiz — CineMatch (Ταινίες)</title>
    <link rel="stylesheet" href="quiz.css" />
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="Κύριο μενού">
        <div class="nav-container">
            <a href="index.html" class="logo-link" title="CineMatch">
                <img src="/logo.png" alt="CineMatch" class="logo-img">
            </a>
            <ul class="nav-menu" role="menubar">
                <li><a href="/" data-page="home" class="nav-link">Home</a></li>
                <li><a href="/search" class="nav-link">Search</a></li>
                <li><a href="/trending" class="nav-link">Trending Movies</a></li>
                <li><a href="/quiz" class="nav-link active">Quiz</a></li>
                <li><a href="/sentiment" class="nav-link">Sentiment Analysis</a></li>
                <li><a href="/face" class="nav-link">Face Detection</a></li>
                <li><a href="/logout" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section id="leaderboard" class="leaderboard-table"></section>

    <main class="page" id="main">
        <header class="page-header">
            <h1>Quiz Ταινιών — 10 Τυχαίες Ερωτήσεις</h1>
            <p>Επίλεξε μία από τις 5 απαντήσεις για κάθε ερώτηση. Θα λάβεις άμεση ανατροφοδότηση και στο τέλος το συνολικό σκορ.</p>
        </header>

        <section class="quiz-container" aria-labelledby="quiz-heading">
            <div class="quiz-card" role="application" aria-live="polite">
                <div class="top-row">
                    <div id="progressText" class="progress-text">Ερώτηση 1 / 10</div>
                    <div id="scoreText" class="score-text">Σκορ: 0</div>
                </div>

                <div id="questionArea" class="question-area" aria-atomic="true">
                    <h2 id="questionTitle">Φόρτωση ερώτησης...</h2>
                </div>

                <div id="choices" class="choices" role="listbox" aria-label="Επιλογές"></div>

                <div class="controls">
                    <button id="nextBtn" class="btn primary" disabled aria-disabled="true">Επόμενη Ερώτηση</button>
                    <button id="restartBtn" class="btn ghost" hidden>Ξεκίνα ξανά</button>
                </div>

                <div id="resultSummary" class="result-summary" hidden aria-live="polite"></div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
      <div class="footer-container">
        <div class="footer-col footer-brand">
          <a href="/" class="logo-link" title="CineMatch">
            <img src="/logo.png" alt="CineMatch logo" class="logo-img footer-logo">
          </a>
          <p class="footer-tagline">Ανακάλυψε ταινίες με έξυπνες προτάσεις και μικρές περιγραφές.</p>
        </div>

        <div class="footer-col footer-nav">
          <h4 class="footer-title">Μενού</h4>
          <ul class="footer-menu">
            <li><a href="/" class="footer-link">Home</a></li>
            <li><a href="/search" class="footer-link">Search</a></li>
            <li><a href="/trending" class="footer-link">Trending Movies</a></li>
            <li><a href="/quiz" class="footer-link">Quiz</a></li>
            <li><a href="/sentiment" class="footer-link">Sentiment Analysis</a></li>
            <li><a href="/face" class="footer-link">Face Detection</a></li>
          </ul>
        </div>

        <div class="footer-col footer-social">
          <h4 class="footer-title">Ακολούθησέ μας</h4>
          <div class="social-links">
            <a href="https://facebook.com" class="social-link" aria-label="Facebook">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 4.99 3.66 9.13 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.88 3.77-3.88 1.09 0 2.23.2 2.23.2v2.45h-1.25c-1.23 0-1.61.76-1.61 1.54v1.85h2.74l-.44 2.9h-2.3v7.03C18.34 21.2 22 17.06 22 12.07z" fill="currentColor"/></svg>
              <span>Facebook</span>
            </a>
            <a href="https://instagram.com" class="social-link" aria-label="Instagram">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 6.2A4.8 4.8 0 1 0 16.8 13 4.8 4.8 0 0 0 12 8.2zm6.5-3.7a1.1 1.1 0 1 0 1.1 1.1 1.1 1.1 0 0 0-1.1-1.1z" fill="currentColor"/></svg>
              <span>Instagram</span>
            </a>
            <a href="https://twitter.com" class="social-link" aria-label="Twitter">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M22 5.92c-.66.29-1.37.48-2.11.57a3.66 3.66 0 0 0 1.6-2.02 7.18 7.18 0 0 1-2.33.9A3.59 3.59 0 0 0 12.2 8.6c0 .28.03.56.09.83A10.2 10.2 0 0 1 3 5.16a3.57 3.57 0 0 0 1.11 4.78 3.5 3.5 0 0 1-1.62-.45v.05a3.6 3.6 0 0 0 2.88 3.52c-.47.13-.97.2-1.48.2-.36 0-.72-.03-1.06-.1a3.6 3.6 0 0 0 3.36 2.5A7.22 7.22 0 0 1 2 19.54 10.21 10.21 0 0 0 7.2 21c6.24 0 9.66-5.18 9.66-9.67v-.44c.66-.48 1.22-1.08 1.67-1.76a10.12 10.12 0 0 1-2.51.68z" fill="currentColor"/></svg>
              <span>Twitter</span>
            </a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="footer-container">
          <p class="small">&copy; <span id="year">2025</span> CineMatch — Όλα τα δικαιώματα διατηρούνται.</p>
          <p class="small muted">Σχεδιασμένο με ❤ για κινηματογραφόφιλους.</p>
        </div>
      </div>
    </footer>

    <script>
        async function loadLeaderboard() {
            const response = await fetch('/api/user/leaderboard');
            if (!response.ok) {
                document.getElementById('leaderboard').innerHTML =
                    "<div class='lb-error'>Leaderboard is not available.</div>";
                return;
            }
            const data = await response.json();
            let html = `<h3 class="lb-title">Leaderboard</h3>
        <table class="lb-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Όνομα χρηστή</th>
                    <th>Καλύτερο Σκορ</th>
                    <th>Παιχνίδια</th>
                </tr>
            </thead>
            <tbody>`;
            data.forEach((entry, idx) => {
                html += `<tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(entry.username)}</td>
            <td>${entry.score}</td>
            <td>${entry.gamesPlayed}</td>
        </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('leaderboard').innerHTML = html;
        }

        // Φώναξέ το on page load!
        window.addEventListener("DOMContentLoaded", () => {
            loadLeaderboard();
        });

        function postScore(finalScore) {
            fetch('/api/user/quiz-history', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ score: finalScore })
            }).then(res => {
                if (res.ok) loadLeaderboard();
            }).catch(() => { });
        }

        let quizQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let answersLog = [];

        const progressText = document.getElementById('progressText');
        const scoreText = document.getElementById('scoreText');
        const questionTitle = document.getElementById('questionTitle');
        const choicesEl = document.getElementById('choices');
        const nextBtn = document.getElementById('nextBtn');
        const restartBtn = document.getElementById('restartBtn');
        const resultSummary = document.getElementById('resultSummary');

        async function fetchQuiz() {
            const res = await fetch(`/api/quiz?amount=10&difficulty=easy`);
            if (!res.ok) {
                throw new Error('HTTP error ' + res.status);
            }
            const data = await res.json();
            return data.questions || [];
        }

        async function startQuiz() {

            quizQuestions = [];
            currentIndex = 0;
            score = 0;
            answersLog = [];

            progressText.textContent = 'Φόρτωση...';
            scoreText.textContent = 'Σκορ: 0';
            questionTitle.textContent = 'Φόρτωση ερώτησης...';
            choicesEl.innerHTML = '';
            resultSummary.hidden = true;
            restartBtn.hidden = true;
            nextBtn.hidden = true;

            try {
               
                quizQuestions = await fetchQuiz();

                if (quizQuestions.length === 0) {
                    questionTitle.textContent = 'Δεν βρέθηκαν ερωτήσεις από το API.';
                    return;
                }

                nextBtn.hidden = false;
                renderQuestion();
            } catch (err) {
                console.error(err);
                questionTitle.textContent =
                    'Προέκυψε σφάλμα κατά τη φόρτωση των ερωτήσεων από το API.';
            }
        }

        function renderQuestion() {
            const item = quizQuestions[currentIndex];

            progressText.textContent = `Ερώτηση ${currentIndex + 1} / ${quizQuestions.length}`;
            scoreText.textContent = `Σκορ: ${score}`;

            questionTitle.textContent = decodeHtml(item.question);

            choicesEl.innerHTML = '';
            choicesEl.dataset.answered = 'false';

            item.answers.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.type = 'button';
                btn.setAttribute('data-index', i);
                btn.setAttribute('role', 'option');
                btn.textContent = decodeHtml(ans);
                btn.addEventListener('click', onChoiceClick);
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
                choicesEl.appendChild(btn);
            });

            nextBtn.disabled = true;
            nextBtn.setAttribute('aria-disabled', 'true');
            nextBtn.hidden = false;
            restartBtn.hidden = true;
            resultSummary.hidden = true;
        }

        function onChoiceClick(e) {
            const selected = Number(e.currentTarget.getAttribute('data-index'));
            const item = quizQuestions[currentIndex];
            if (choicesEl.dataset.answered === 'true') return;
            choicesEl.dataset.answered = 'true';

            const buttons = Array.from(choicesEl.querySelectorAll('.choice-btn'));
            buttons.forEach((b, idx) => {
                b.disabled = true;
                b.classList.remove('chosen-correct', 'chosen-wrong', 'correct');
                if (idx === item.correctIndex) {
                    b.classList.add('correct');
                }
            });

            const selectedBtn = e.currentTarget;
            let correctNow = false;
            if (selected === item.correctIndex) {
                selectedBtn.classList.add('chosen-correct');
                score++;
                correctNow = true;
                scoreText.textContent = `Σκορ: ${score}`;
            } else {
                selectedBtn.classList.add('chosen-wrong');
            }

            answersLog.push({
                question: item.question,
                selectedIndex: selected,
                correctIndex: item.correctIndex,
                answers: item.answers.slice()
            });

            const feedback = document.createElement('div');
            feedback.className = 'feedback';
            feedback.textContent = correctNow ? 'Σωστό!' : 'Λάθος!';
            choicesEl.appendChild(feedback);

            nextBtn.disabled = false;
            nextBtn.setAttribute('aria-disabled', 'false');
        }

        nextBtn.addEventListener('click', () => {
            currentIndex++;
            if (currentIndex < quizQuestions.length) {
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showSummary();
            }
        });

        restartBtn.addEventListener('click', () => startQuiz());

        function showSummary() {
            progressText.textContent = 'Ολοκληρώθηκε';
            questionTitle.textContent = `Τελικό σκορ: ${score} / ${quizQuestions.length}`;
            choicesEl.innerHTML = '';
            nextBtn.hidden = true;
            restartBtn.hidden = false;
            resultSummary.hidden = false;

            let html = `<h3>Αποτελέσματα</h3>`;
            html += `<p>Σύνολο σωστών: <strong>${score}</strong> από ${quizQuestions.length}</p>`;
            html += `<div class="review">`;

            answersLog.forEach((a, i) => {
                const correctTextRaw = a.answers[a.correctIndex] ?? '';
                const selectedTextRaw = a.answers[a.selectedIndex] ?? '';
                const correctText = decodeHtml(correctTextRaw);
                const selectedText = decodeHtml(selectedTextRaw);
                const ok = a.selectedIndex === a.correctIndex;

                html += `<div class="review-item">
                        <div class="r-q"><strong>Q${i + 1}:</strong> ${escapeHtml(decodeHtml(a.question))}</div>
                        <div class="r-ans ${ok ? 'ok' : 'bad'}">
                            <div>Η δική σου απάντηση: <span class="user">${escapeHtml(selectedText)}</span></div>
                            <div>Σωστή απάντηση: <span class="correct">${escapeHtml(correctText)}</span></div>
                        </div>
                     </div>`;
            });

            html += `</div>`;
            resultSummary.innerHTML = html;
            postScore(score);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function escapeHtml(unsafe) {
            if (!unsafe && unsafe !== '') return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }

        startQuiz();
    </script>

    <script>
      (function updateFooterYear() {
        const y = new Date().getFullYear();
        const el = document.getElementById('year');
        if (el) el.textContent = y;
      })();
    </script>
</body>
</html>
