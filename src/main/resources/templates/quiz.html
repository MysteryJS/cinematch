<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quiz — CineMatch (Ταινίες)</title>
    <link rel="stylesheet" href="quiz.css" />
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="Κύριο μενού">
        <div class="nav-container">
            <a href="index.html" class="logo-link" title="CineMatch">
                <img src="/logo.png" alt="CineMatch" class="logo-img">
            </a>
            <ul class="nav-menu" role="menubar">
                <li><a href="/" data-page="home" class="nav-link">Home</a></li>
                <li><a href="/search" class="nav-link">Search</a></li>
                <li><a href="/trending" class="nav-link">Trending Movies</a></li>
                <li><a href="/quiz" class="nav-link active">Quiz</a></li>
                <li><a href="/sentiment" class="nav-link">Sentiment Analysis</a></li>
                <li><a href="/face" class="nav-link">Face Detection</a></li>
                <li><a href="/logout" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section id="leaderboard" class="leaderboard-table"></section>

    <main class="page" id="main">
        <header class="page-header">
            <h1>Quiz Ταινιών — 10 Τυχαίες Ερωτήσεις</h1>
            <p>Επίλεξε μία από τις 5 απαντήσεις για κάθε ερώτηση. Θα λάβεις άμεση ανατροφοδότηση και στο τέλος το συνολικό σκορ.</p>
        </header>

        <section class="quiz-container" aria-labelledby="quiz-heading">
            <div class="quiz-card" role="application" aria-live="polite">
                <div class="top-row">
                    <div id="progressText" class="progress-text">Ερώτηση 1 / 10</div>
                    <div id="scoreText" class="score-text">Σκορ: 0</div>
                </div>

                <div id="questionArea" class="question-area" aria-atomic="true">
                    <h2 id="questionTitle">Φόρτωση ερώτησης...</h2>
                </div>

                <div id="choices" class="choices" role="listbox" aria-label="Επιλογές"></div>

                <div class="controls">
                    <button id="nextBtn" class="btn primary" disabled aria-disabled="true">Επόμενη Ερώτηση</button>
                    <button id="restartBtn" class="btn ghost" hidden>Ξεκίνα ξανά</button>
                </div>

                <div id="resultSummary" class="result-summary" hidden aria-live="polite"></div>
            </div>
        </section>

        <footer class="footer">
            <div class="container">
                <p>© CineMatch Quiz — Ερωτήσεις με θέμα τις ταινίες.</p>
            </div>
        </footer>
    </main>

    <script>
        async function loadLeaderboard() {
            const response = await fetch('/api/user/leaderboard');
            if (!response.ok) {
                document.getElementById('leaderboard').innerHTML =
                    "<div class='lb-error'>Leaderboard is not available.</div>";
                return;
            }
            const data = await response.json();
            let html = `<h3 class="lb-title">Leaderboard</h3>
        <table class="lb-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Όνομα χρηστή</th>
                    <th>Καλύτερο Σκορ</th>
                    <th>Παιχνίδια</th>
                </tr>
            </thead>
            <tbody>`;
            data.forEach((entry, idx) => {
                html += `<tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(entry.username)}</td>
            <td>${entry.score}</td>
            <td>${entry.gamesPlayed}</td>
        </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('leaderboard').innerHTML = html;
        }

        // Φώναξέ το on page load!
        window.addEventListener("DOMContentLoaded", () => {
            loadLeaderboard();
        });

        function postScore(finalScore) {
            fetch('/api/user/quiz-history', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ score: finalScore })
            }).then(res => {
                if (res.ok) loadLeaderboard();
            }).catch(() => { });
        }

        // state
        let quizQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let answersLog = []; // { question, selectedIndex, correctIndex, answers }

        const progressText = document.getElementById('progressText');
        const scoreText = document.getElementById('scoreText');
        const questionTitle = document.getElementById('questionTitle');
        const choicesEl = document.getElementById('choices');
        const nextBtn = document.getElementById('nextBtn');
        const restartBtn = document.getElementById('restartBtn');
        const resultSummary = document.getElementById('resultSummary');

        async function fetchQuiz(amount = 10, difficulty = 'easy') {
            const res = await fetch(`/api/quiz?amount=${amount}&difficulty=${difficulty}`);
            if (!res.ok) {
                throw new Error('HTTP error ' + res.status);
            }
            const data = await res.json();
            return data.questions || [];
        }

        async function startQuiz() {
            // reset state
            quizQuestions = [];
            currentIndex = 0;
            score = 0;
            answersLog = [];

            progressText.textContent = 'Φόρτωση...';
            scoreText.textContent = 'Σκορ: 0';
            questionTitle.textContent = 'Φόρτωση ερώτησης...';
            choicesEl.innerHTML = '';
            resultSummary.hidden = true;
            restartBtn.hidden = true;
            nextBtn.hidden = true;

            try {
                // Φέρνουμε 10 ερωτήσεις difficulty=easy (μπορείς να το αλλάξεις)
                quizQuestions = await fetchQuiz(10, 'easy');

                if (quizQuestions.length === 0) {
                    questionTitle.textContent = 'Δεν βρέθηκαν ερωτήσεις από το API.';
                    return;
                }

                nextBtn.hidden = false;
                renderQuestion();
            } catch (err) {
                console.error(err);
                questionTitle.textContent =
                    'Προέκυψε σφάλμα κατά τη φόρτωση των ερωτήσεων από το API.';
            }
        }

        function renderQuestion() {
            const item = quizQuestions[currentIndex];

            progressText.textContent = `Ερώτηση ${currentIndex + 1} / ${quizQuestions.length}`;
            scoreText.textContent = `Σκορ: ${score}`;

            // Τα string από OpenTDB έχουν HTML entities (π.χ. &quot;), τα κάνουμε decode
            questionTitle.textContent = decodeHtml(item.question);

            choicesEl.innerHTML = '';
            choicesEl.dataset.answered = 'false';

            item.answers.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.type = 'button';
                btn.setAttribute('data-index', i);
                btn.setAttribute('role', 'option');
                btn.textContent = decodeHtml(ans);
                btn.addEventListener('click', onChoiceClick);
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
                choicesEl.appendChild(btn);
            });

            nextBtn.disabled = true;
            nextBtn.setAttribute('aria-disabled', 'true');
            nextBtn.hidden = false;
            restartBtn.hidden = true;
            resultSummary.hidden = true;
        }

        function onChoiceClick(e) {
            const selected = Number(e.currentTarget.getAttribute('data-index'));
            const item = quizQuestions[currentIndex];
            if (choicesEl.dataset.answered === 'true') return;
            choicesEl.dataset.answered = 'true';

            const buttons = Array.from(choicesEl.querySelectorAll('.choice-btn'));
            buttons.forEach((b, idx) => {
                b.disabled = true;
                b.classList.remove('chosen-correct', 'chosen-wrong', 'correct');
                if (idx === item.correctIndex) {
                    b.classList.add('correct');
                }
            });

            const selectedBtn = e.currentTarget;
            let correctNow = false;
            if (selected === item.correctIndex) {
                selectedBtn.classList.add('chosen-correct');
                score++;
                correctNow = true;
                scoreText.textContent = `Σκορ: ${score}`;
            } else {
                selectedBtn.classList.add('chosen-wrong');
            }

            answersLog.push({
                question: item.question,
                selectedIndex: selected,
                correctIndex: item.correctIndex,
                answers: item.answers.slice()
            });

            const feedback = document.createElement('div');
            feedback.className = 'feedback';
            feedback.textContent = correctNow ? 'Σωστό!' : 'Λάθος!';
            choicesEl.appendChild(feedback);

            nextBtn.disabled = false;
            nextBtn.setAttribute('aria-disabled', 'false');
        }

        nextBtn.addEventListener('click', () => {
            currentIndex++;
            if (currentIndex < quizQuestions.length) {
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showSummary();
            }
        });

        restartBtn.addEventListener('click', () => startQuiz());

        function showSummary() {
            progressText.textContent = 'Ολοκληρώθηκε';
            questionTitle.textContent = `Τελικό σκορ: ${score} / ${quizQuestions.length}`;
            choicesEl.innerHTML = '';
            nextBtn.hidden = true;
            restartBtn.hidden = false;
            resultSummary.hidden = false;

            let html = `<h3>Αποτελέσματα</h3>`;
            html += `<p>Σύνολο σωστών: <strong>${score}</strong> από ${quizQuestions.length}</p>`;
            html += `<div class="review">`;

            answersLog.forEach((a, i) => {
                const correctTextRaw = a.answers[a.correctIndex] ?? '';
                const selectedTextRaw = a.answers[a.selectedIndex] ?? '';
                const correctText = decodeHtml(correctTextRaw);
                const selectedText = decodeHtml(selectedTextRaw);
                const ok = a.selectedIndex === a.correctIndex;

                html += `<div class="review-item">
                        <div class="r-q"><strong>Q${i + 1}:</strong> ${escapeHtml(decodeHtml(a.question))}</div>
                        <div class="r-ans ${ok ? 'ok' : 'bad'}">
                            <div>Η δική σου απάντηση: <span class="user">${escapeHtml(selectedText)}</span></div>
                            <div>Σωστή απάντηση: <span class="correct">${escapeHtml(correctText)}</span></div>
                        </div>
                     </div>`;
            });

            html += `</div>`;
            resultSummary.innerHTML = html;
            postScore(score);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // safety helper
        function escapeHtml(unsafe) {
            if (!unsafe && unsafe !== '') return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // decode HTML entities από OpenTDB (π.χ. &quot;, &#039;)
        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }

        // ξεκινάει αυτόματα όταν φορτώνει η σελίδα
        startQuiz();
    </script>
</body>
</html>