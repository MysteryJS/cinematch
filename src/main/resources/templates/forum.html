<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch Forum</title>
    <link rel="stylesheet" href="/home.css">
</head>

<body>

<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="logo-link" title="CineMatch">
            <img src="/logo.png" alt="CineMatch logo" class="logo-img">
        </a>
        <ul class="nav-menu">
            <li><a href="/" class="nav-link">Home</a></li>
            <li><a href="/search" class="nav-link">Search</a></li>
            <li><a href="/trending" class="nav-link">Trending Movies</a></li>
            <li><a href="/quiz" class="nav-link">Quiz</a></li>
            <li><a href="/sentiment" class="nav-link">Sentiment Analysis</a></li>
            <li><a href="/face" class="nav-link">Face Detection</a></li>
            <li><a href="/forum" class="nav-link active">Forum</a></li>
        </ul>
    </div>
</nav>

<section class="page active">
    <div class="container">

    <h1>CineMatch Forum</h1>

    <section class="categories">
        <h2>Κατηγορίες</h2>
        <div class="kpi-container">
            <div class="kpi-box">Ταινίες Τρόμου</div>
            <div class="kpi-box">Κωμωδίες</div>
            <div class="kpi-box">Δράμα</div>
            <div class="kpi-box">Περιπέτεια</div>
            <div class="kpi-box">Σειρές</div>
            <div class="kpi-box">Προτάσεις Χρηστών</div>
        </div>

    </section>

        <section class="posts" id="posts">
            <h2>Τελευταίες Συζητήσεις</h2>
        </section>

        <section class="search-container">
        <h2>Δημιούργησε νέο θέμα</h2>

        <input type="text" id="postTitle" placeholder="Τίτλος θέματος">
        <textarea rows="5" id="postContent" placeholder="Το μήνυμα σας..."></textarea>

        <button id="submitPost">Δημοσίευση</button>
    </section>

</div>
</section>

<div class="footer-bottom">
    <div class="footer-container" style="text-align:center; padding:20px; color:#555;">
        <p class="small">&copy; <span id="year">2025</span> CineMatch — Όλα τα δικαιώματα διατηρούνται.</p>
        <p class="small muted">Σχεδιασμένο με ❤ για κινηματογραφόφιλους.</p>
        <a href="/TOU" class="footer-link" style="margin-top:10px; display:inline-block;">Όροι Χρήσης</a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      loadPosts();
      document.getElementById("submitPost").addEventListener("click", createPost);
    });

    async function loadPosts() {
      const res = await fetch("/api/forum/posts");
      const posts = await res.json();

      const container = document.getElementById("posts");
      container.innerHTML = "<h2>Τελευταίες Συζητήσεις</h2>";

      if (!posts.length) {
        container.innerHTML += "<p>Δεν υπάρχουν ακόμη θέματα.</p>";
        return;
      }

      posts.forEach(post => {
        const created = post.createdAt
          ? new Date(post.createdAt).toLocaleString()
          : "";

        const username = post.username ?? "unknown";

        container.innerHTML += `
          <div class="movie-card">
            <div class="post-title">${post.title}</div>
            <div class="post-meta">
              Χρήστης: ${username} | ${created}
            </div>
            <p>${post.content}</p>

            <div id="comments-${post.id}">
              <small>Φόρτωση σχολίων...</small>
            </div>

            <textarea id="comment-input-${post.id}" placeholder="Γράψε σχόλιο..."></textarea>
            <button onclick="addComment(${post.id})">Σχόλιο</button>
          </div>
        `;

        loadComments(post.id);
      });
    }

    async function loadComments(postId) {
      const res = await fetch(`/api/forum/comments/${postId}`);
      const comments = await res.json();

      const div = document.getElementById(`comments-${postId}`);
      div.innerHTML = "";

      if (!comments.length) {
        div.innerHTML = "<small>Δεν υπάρχουν σχόλια.</small>";
        return;
      }

      comments.forEach(c => {
        div.innerHTML += `
          <div class="comment">
            <small>${new Date(c.createdAt).toLocaleString()}</small>
            <p>${c.content}</p>
          </div>
        `;
      });
    }

    async function addComment(postId) {
      const textarea = document.getElementById(`comment-input-${postId}`);
      const content = textarea.value.trim();

      if (!content) {
        alert("Γράψε σχόλιο");
        return;
      }

      const res = await fetch(`/api/forum/comments/${postId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content })
      });

      if (!res.ok) {
        alert("Σφάλμα στο σχόλιο");
        return;
      }

      textarea.value = "";
      loadComments(postId);
    }

    async function createPost() {
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();

  if (!title || !content) {
    alert("Συμπλήρωσε τίτλο και μήνυμα");
    return;
  }

  const res = await fetch("/api/forum/post", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, content })
  });

  if (!res.ok) {
    alert("Σφάλμα στη δημοσίευση");
    return;
  }

  document.getElementById("postTitle").value = "";
  document.getElementById("postContent").value = "";

  loadPosts();
}

</script>

</body>

</html>
