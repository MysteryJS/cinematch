<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch Forum</title>

    <link rel="stylesheet" href="/home.css">
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo-link" title="CineMatch">
                <img src="/logo.png" alt="CineMatch logo" class="logo-img">
            </a>

            <ul class="nav-menu">
                <li><a href="/" data-page="home" class="nav-link">Home</a></li>
                <li><a href="/search" class="nav-link">Search</a></li>
                <li><a href="/trending" class="nav-link">Trending Movies</a></li>
                <li><a href="/quiz" class="nav-link">Quiz</a></li>
                <li><a href="/sentiment" class="nav-link">Sentiment Analysis</a></li>
                <li><a href="/face" class="nav-link active">Face Detection</a></li>
                <li><a href="/forum" class="footer-link">Forum</a></li>
                <li th:if="${isLoggedIn}">
                    <a href="/logout" class="nav-link">Logout</a>
                </li>
                <li th:unless="${isLoggedIn}">
                    <a href="/login" class="nav-link">Login</a>
                </li>
            </ul>
            <div class="lang-switcher">
                <button id="lang-btn" class="lang-btn">
                    <span id="lang-flag" style="font-size:20px;">ğŸ‡¬ğŸ‡·</span>
                    <span id="lang-text">GR</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="page active">
        <div class="container">

            <section class="categories">
                <h2>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</h2>
                <div class="kpi-container">
                    <div class="kpi-box" data-category="Horror">Î¤Î±Î¹Î½Î¯ÎµÏ‚ Î¤ÏÏŒÎ¼Î¿Ï…</div>
                    <div class="kpi-box" data-category="Comedy">ÎšÏ‰Î¼Ï‰Î´Î¯ÎµÏ‚</div>
                    <div class="kpi-box" data-category="Drama">Î”ÏÎ¬Î¼Î±</div>
                    <div class="kpi-box" data-category="Adventure">Î ÎµÏÎ¹Ï€Î­Ï„ÎµÎ¹Î±</div>
                    <div class="kpi-box" data-category="Series">Î£ÎµÎ¹ÏÎ­Ï‚</div>
                    <div class="kpi-box" data-category="Suggestions">Î ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î§ÏÎ·ÏƒÏ„ÏÎ½</div>
                </div>
            </section>

            <section class="posts">
                <h2>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î£Ï…Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚</h2>

                <div id="postsEmpty" class="text-muted" style="display:none;">
                    Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ posts Î±ÎºÏŒÎ¼Î±.
                </div>

                <div id="postsContainer"></div>
            </section>

            <section class="search-container">
                <h2>Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Î½Î­Î¿ Î¸Î­Î¼Î±</h2>

                <input id="postTitle" type="text" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚ Î¸Î­Î¼Î±Ï„Î¿Ï‚">
                <textarea id="postContent" rows="5" placeholder="Î¤Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ±Ï‚..."></textarea>
                <input id="postMedia" type="file" accept="image/*,video/*" multiple>
                <div id="mediaPreview"></div>
                <button id="submitPostBtn">Î”Î·Î¼Î¿ÏƒÎ¯ÎµÏ…ÏƒÎ·</button>
            </section>

        </div>
    </main>

   <footer class="site-footer" aria-label="Footer">
        <div class="footer-container">
            <div class="footer-col footer-brand">
                <a href="/" class="logo-link" title="CineMatch">
                    <img src="/logo.png" alt="CineMatch logo" class="logo-img footer-logo">
                </a>
                <p class="footer-tagline">Discover movies with smart suggestions and short descriptions.</p>
            </div>

            <div class="footer-col footer-nav">
                <h4 class="footer-title">Menu</h4>
                <ul class="footer-menu">
                    <li><a href="/" class="footer-link">Home</a></li>
                    <li><a href="/search" class="footer-link">Search</a></li>
                    <li><a href="/trending" class="footer-link">Trending Movies</a></li>
                    <li><a href="/quiz" class="footer-link">Quiz</a></li>
                    <li><a href="/sentiment" class="footer-link">Sentiment Analysis</a></li>
                    <li><a href="/face" class="footer-link">Face Detection</a></li>
                    <li><a href="/forum" class="footer-link">Forum</a></li>
                </ul>
            </div>

            <div class="footer-col footer-social">
                <h4 class="footer-title">Follow us</h4>
                <div class="social-links">
                    <a href="https://facebook.com/" class="social-link" aria-label="Facebook" target="_blank"
                        rel="noopener noreferrer">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path
                                d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 4.99 3.66 9.13 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.88 3.77-3.88 1.09 0 2.23.2 2.23.2v2.45h-1.25c-1.23 0-1.61.76-1.61 1.54v1.85h2.74l-.44 2.9h-2.3v7.03C18.34 21.2 22 17.06 22 12.07z"
                                fill="currentColor" />
                        </svg>
                        <span>Facebook</span>
                    </a>
                    <a href="https://instagram.com/" class="social-link" aria-label="Instagram" target="_blank"
                        rel="noopener noreferrer">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path
                                d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 6.2A4.8 4.8 0 1 0 16.8 13 4.8 4.8 0 0 0 12 8.2zm6.5-3.7a1.1 1.1 0 1 0 1.1 1.1 1.1 1.1 0 0 0-1.1-1.1z"
                                fill="currentColor" />
                        </svg>
                        <span>Instagram</span>
                    </a>
                    <a href="https://twitter.com/" class="social-link" aria-label="Twitter" target="_blank"
                        rel="noopener noreferrer">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path
                                d="M22 5.92c-.66.29-1.37.48-2.11.57a3.66 3.66 0 0 0 1.6-2.02 7.18 7.18 0 0 1-2.33.9A3.59 3.59 0 0 0 12.2 8.6c0 .28.03.56.09.83A10.2 10.2 0 0 1 3 5.16a3.57 3.57 0 0 0 1.11 4.78 3.5 3.5 0 0 1-1.62-.45v.05a3.6 3.6 0 0 0 2.88 3.52c-.47.13-.97.2-1.48.2-.36 0-.72-.03-1.06-.1a3.6 3.6 0 0 0 3.36 2.5A7.22 7.22 0 0 1 2 19.54 10.21 10.21 0 0 0 7.2 21c6.24 0 9.66-5.18 9.66-9.67v-.44c.66-.48 1.22-1.08 1.67-1.76a10.12 10.12 0 0 1-2.51.68z"
                                fill="currentColor" />
                        </svg>
                        <span>Twitter</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="footer-container">
                <p class="small">&copy; <span id="year">2025</span> CineMatch â€” All rights reserved.</p>
                <p class="small muted">Designed with â¤ for movie lovers.</p>

                <a href="/TOU" class="footer-link" style="margin-top:10px; display:inline-block;">
                    Terms of Use
                </a>
            </div>
        </div>
    </footer>

    <script>
        let selectedCategory = null;

        function appendMedia(card, mediaUrls) {
            if (!mediaUrls || mediaUrls.length === 0) return;

            const mediaWrap = document.createElement('div');
            mediaWrap.style.marginTop = '10px';

            for (const url of mediaUrls) {
                if (!url) continue;

                if (url.includes('/uploads/images/')) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.maxWidth = '400px';
                    img.style.display = 'block';
                    img.style.marginTop = '8px';
                    mediaWrap.appendChild(img);
                    continue;
                }

                if (url.includes('/uploads/videos/')) {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.style.maxWidth = '400px';
                    video.style.display = 'block';
                    video.style.marginTop = '8px';

                    const source = document.createElement('source');
                    source.src = url;
                    video.appendChild(source);

                    mediaWrap.appendChild(video);
                }
            }

            card.appendChild(mediaWrap);
        }

        async function uploadFilesForPost(postId, files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                const res = await fetch(`/forum/media/${postId}`, {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Upload failed');
                }
            }
        }

        async function loadPosts() {
            let url = '/api/forum/posts';
            if (selectedCategory) {
                url += '?category=' + encodeURIComponent(selectedCategory);
            }

            const res = await fetch(url);
            if (!res.ok) {
                document.getElementById('postsEmpty').style.display = 'block';
                document.getElementById('postsEmpty').textContent = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ posts.';
                return;
            }

            const posts = await res.json();

            const emptyEl = document.getElementById('postsEmpty');
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';

            if (!posts || posts.length === 0) {
                emptyEl.style.display = 'block';
                emptyEl.textContent = 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ posts ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.';
                return;
            }

            emptyEl.style.display = 'none';

            for (const p of posts) {
                const card = document.createElement('div');
                card.className = 'movie-card';

                const createdAt = p.createdAt ? new Date(p.createdAt).toLocaleString('el-GR') : 'â€”';

                card.innerHTML = `
                <div class="movie-title"></div>
                <div class="text-muted small"></div>
                <p></p>
            `;

                card.querySelector('.movie-title').textContent = p.title ?? '';
                card.querySelector('.text-muted').textContent = `Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${p.username ?? 'unknown'} | Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${createdAt}`;
                card.querySelector('p').textContent = p.content ?? '';

                appendMedia(card, p.mediaUrls);
                container.appendChild(card);
            }
        }

        function selectCategory(category) {
            selectedCategory = category;
            loadPosts();
        }

        async function getVideoDurationSeconds(file) {
            return await new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const v = document.createElement('video');
                v.preload = 'metadata';
                v.onloadedmetadata = () => {
                    const d = v.duration;
                    URL.revokeObjectURL(url);
                    if (!isFinite(d)) reject(new Error('Cannot read video duration'));
                    else resolve(d);
                };
                v.onerror = () => {
                    URL.revokeObjectURL(url);
                    reject(new Error('Cannot read video'));
                };
                v.src = url;
            });
        }

        async function validateSelectedFiles(files) {
            const out = [];
            for (const f of files) {
                if (f.type && f.type.startsWith('video/')) {
                    const dur = await getVideoDurationSeconds(f);
                    if (dur > 60) {
                        throw new Error(`Î¤Î¿ video "${f.name}" ÎµÎ¯Î½Î±Î¹ ${Math.ceil(dur)}s. Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Î¹ Î­Ï‰Ï‚ 60s.`);
                    }
                }
                out.push(f);
            }
            return out;
        }

        function renderSelectedMediaPreview(files) {
            const wrap = document.getElementById('mediaPreview');
            if (!wrap) return;

            wrap.innerHTML = '';

            if (!files || files.length === 0) return;

            for (const f of files) {
                const row = document.createElement('div');
                row.className = 'text-muted small';
                row.style.marginTop = '6px';
                row.textContent = `${f.name} (${Math.ceil(f.size / 1024)} KB)`;
                wrap.appendChild(row);

                if (f.type && f.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(f);
                    img.style.maxWidth = '200px';
                    img.style.display = 'block';
                    img.style.marginTop = '6px';
                    wrap.appendChild(img);
                }
            }
        }


        async function submitPost() {
            const titleEl = document.getElementById('postTitle');
            const contentEl = document.getElementById('postContent');
            const mediaEl = document.getElementById('postMedia');

            const title = titleEl.value.trim();
            const content = contentEl.value.trim();

            if (!title || !content) return;

            const res = await fetch('/api/forum/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    category: selectedCategory || 'General'
                })
            });

            if (!res.ok) {
                const text = await res.text();
                alert(text || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î·Î¼Î¿ÏƒÎ¯ÎµÏ…ÏƒÎ·Ï‚.');
                return;
            }

            const createdPost = await res.json();
            const postId = createdPost.id;

            const rawFiles = mediaEl && mediaEl.files ? Array.from(mediaEl.files) : [];
            let files = [];

            try {
                files = await validateSelectedFiles(rawFiles);
            } catch (e) {
                alert(e.message);
                return;
            }


            try {
                if (files.length > 0) {
                    await uploadFilesForPost(postId, files);
                }
            } catch (e) {
                alert('Î¤Î¿ post Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ, Î±Î»Î»Î¬ Î±Ï€Î­Ï„Ï…Ï‡Îµ Ï„Î¿ upload Ï„Ï‰Î½ media: ' + e.message);
            }

            titleEl.value = '';
            contentEl.value = '';
            if (mediaEl) mediaEl.value = '';
            renderSelectedMediaPreview([]);

            await loadPosts();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();

            document.querySelectorAll('.kpi-box[data-category]').forEach(btn => {
                btn.addEventListener('click', () => selectCategory(btn.dataset.category));
            });

            const mediaEl = document.getElementById('postMedia');
            if (mediaEl) {
                mediaEl.addEventListener('change', async () => {
                    const rawFiles = Array.from(mediaEl.files || []);
                    try {
                        await validateSelectedFiles(rawFiles);
                        renderSelectedMediaPreview(rawFiles);
                    } catch (e) {
                        alert(e.message);
                        mediaEl.value = '';
                        renderSelectedMediaPreview([]);
                    }
                });
            }

            document.getElementById('submitPostBtn').addEventListener('click', submitPost);
        });

    </script>


</body>

</html>