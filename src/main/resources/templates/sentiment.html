<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <title>Movie Sentiment API Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="sentiment.css">
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo-link" title="CineMatch">
                <img src="/logo.png" alt="CineMatch logo" class="logo-img">
            </a>
            <ul class="nav-menu">
                <li><a href="/" data-page="home" class="nav-link">Home</a></li>
                <li><a href="/search" class="nav-link">Search</a></li>
                <li><a href="/trending" class="nav-link">Trending Movies</a></li>
                <li><a href="/quiz" class="nav-link">Quiz</a></li>
                <li><a href="/sentiment" class="nav-link active">Sentiment Analysis</a></li>
                <li><a href="/face" class="nav-link">Face Detection</a></li>
            </ul>
        </div>
    </nav>

    <section class="page active">
        <div class="main">
            <div class="page-header">
                <h2>Ανάλυση & Προτάσεις API</h2>
                <p>Γράψε το σχόλιό σου και πάρε προτάσεις ταινιών με συναισθήματα και είδη!</p>
            </div>
            <textarea id="reviewText" rows="5" placeholder="Γράψε εδώ..."></textarea>
            <br>
            <div class="sentiment-btn-group">
                <button id="analyzeBtn" class="main-btn">Αποστολή στο API</button>
            </div>

            <div id="genresArea" class="subresult"></div>
            <div id="emotionsArea" class="subresult"></div>
            <div id="titlesArea" class="subresult"></div>
            <div id="result" class="result"></div>
        </div>
    </section>

    <footer class="site-footer" aria-label="Footer">
      <div class="footer-container">
        <div class="footer-col footer-brand">
          <a href="/" class="logo-link" title="CineMatch">
            <img src="/logo.png" alt="CineMatch logo" class="logo-img footer-logo">
          </a>
          <p class="footer-tagline">Ανακάλυψε ταινίες με έξυπνες προτάσεις και μικρές περιγραφές.</p>
        </div>

        <div class="footer-col footer-nav">
          <h4 class="footer-title">Μενού</h4>
          <ul class="footer-menu">
            <li><a href="/" class="footer-link">Home</a></li>
            <li><a href="/search" class="footer-link">Search</a></li>
            <li><a href="/trending" class="footer-link">Trending Movies</a></li>
            <li><a href="/quiz" class="footer-link">Quiz</a></li>
            <li><a href="/sentiment" class="footer-link">Sentiment Analysis</a></li>
            <li><a href="/face" class="footer-link">Face Detection</a></li>
          </ul>
        </div>

        <div class="footer-col footer-social">
          <h4 class="footer-title">Ακολούθησέ μας</h4>
          <div class="social-links">
            <a href="https://facebook.com" class="social-link" aria-label="Facebook">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 4.99 3.66 9.13 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.88 3.77-3.88 1.09 0 2.23.2 2.23.2v2.45h-1.25c-1.23 0-1.61.76-1.61 1.54v1.85h2.74l-.44 2.9h-2.3v7.03C18.34 21.2 22 17.06 22 12.07z" fill="currentColor"/></svg>
              <span>Facebook</span>
            </a>
            <a href="https://instagram.com" class="social-link" aria-label="Instagram">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 6.2A4.8 4.8 0 1 0 16.8 13 4.8 4.8 0 0 0 12 8.2zm6.5-3.7a1.1 1.1 0 1 0 1.1 1.1 1.1 1.1 0 0 0-1.1-1.1z" fill="currentColor"/></svg>
              <span>Instagram</span>
            </a>
            <a href="https://twitter.com" class="social-link" aria-label="Twitter">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M22 5.92c-.66.29-1.37.48-2.11.57a3.66 3.66 0 0 0 1.6-2.02 7.18 7.18 0 0 1-2.33.9A3.59 3.59 0 0 0 12.2 8.6c0 .28.03.56.09.83A10.2 10.2 0 0 1 3 5.16a3.57 3.57 0 0 0 1.11 4.78 3.5 3.5 0 0 1-1.62-.45v.05a3.6 3.6 0 0 0 2.88 3.52c-.47.13-.97.2-1.48.2-.36 0-.72-.03-1.06-.1a3.6 3.6 0 0 0 3.36 2.5A7.22 7.22 0 0 1 2 19.54 10.21 10.21 0 0 0 7.2 21c6.24 0 9.66-5.18 9.66-9.67v-.44c.66-.48 1.22-1.08 1.67-1.76a10.12 10.12 0 0 1-2.51.68z" fill="currentColor"/></svg>
              <span>Twitter</span>
            </a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="footer-container">
          <p class="small">&copy; <span id="year">2025</span> CineMatch — Όλα τα δικαιώματα διατηρούνται.</p>
          <p class="small muted">Σχεδιασμένο με ❤ για κινηματογραφόφιλους.</p>
        </div>
      </div>
    </footer>

    <script>
        document.getElementById('analyzeBtn').onclick = async function () {
            const text = document.getElementById('reviewText').value.trim();

            const resultDiv = document.getElementById('result');
            const genresDiv = document.getElementById('genresArea');
            const emotionsDiv = document.getElementById('emotionsArea');
            const titlesDiv = document.getElementById('titlesArea');

            genresDiv.innerHTML = '';
            emotionsDiv.innerHTML = '';
            titlesDiv.innerHTML = '';
            resultDiv.innerHTML = '';

            if (!text) {
                resultDiv.innerHTML = "<span class='error'>Συμπλήρωσε κείμενο.</span>";
                return;
            }

            resultDiv.innerHTML = "Γίνεται αποστολή στο API...";

            try {
                const response = await fetch("http://localhost:5000/recommend", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    resultDiv.innerHTML = "<span class='error'>Σφάλμα API / δεν είναι διαθέσιμο.</span>";
                    return;
                }

                let data;
                try {
                    data = await response.json();
                } catch (parseErr) {
                    resultDiv.innerHTML = "<span class='error'>Το API επέστρεψε μη αναγνωρίσιμο JSON.</span>";
                    return;
                }

                resultDiv.innerHTML = ""; 

                if (data.genres && Array.isArray(data.genres)) {
                    genresDiv.innerHTML =
                        "<strong>Είδη (Genres):</strong> <ul>" +
                        data.genres.map(g => `<li>${g}</li>`).join('') +
                        "</ul>";
                } else {
                    genresDiv.innerHTML = "<strong>Genres:</strong> —";
                }

                if (data.emotion_probabilities && typeof data.emotion_probabilities === 'object') {
                    let rows = "";
                    for (const [emotion, prob] of Object.entries(data.emotion_probabilities)) {
                        rows += `<tr><td>${emotion}</td><td>${prob.toFixed(2)}%</td></tr>`;
                    }
                    emotionsDiv.innerHTML =
                        `<strong>Πιθανότητες συναισθημάτων:</strong>
                <table class="emotions-table">
                  <thead><tr><th>Συναίσθημα</th><th>Πιθανότητα</th></tr></thead>
                  <tbody>${rows}</tbody>
                </table>`;
                } else {
                    emotionsDiv.innerHTML = "<strong>Probabilities:</strong> —";
                }

                function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return String(unsafe)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

if (data.titles && Array.isArray(data.titles)) {
  titlesDiv.innerHTML = "<strong>Αναλυτικά αποτελέσματα ταινιών:</strong>";
  const list = document.createElement("ul");
  list.className = 'movie-list';
  titlesDiv.appendChild(list);

  const movieDetails = await Promise.all(data.titles.map(async title => {
    try {
      const searchRes = await fetch(`http://localhost:8080/api/movie/${encodeURIComponent(title)}`);
      if (!searchRes.ok) return { title, details: null };
      const details = await searchRes.json();
      return { title, details };
    } catch (e) {
      console.error('fetch movie error', title, e);
      return { title, details: null };
    }
  }));

  movieDetails.forEach(({ title, details }) => {
    const li = document.createElement('li');
    li.className = 'movie-item';

    if (details && details.Title) {
      // poster handling
      let poster = details.Poster && details.Poster !== 'N/A' ? details.Poster : '/placeholder-poster.png';

      li.innerHTML = `
        <div class="movie-card">
          <img class="movie-poster" src="${escapeHtml(poster)}" alt="${escapeHtml(details.Title)} poster"
               onerror="this.onerror=null;this.src='/placeholder-poster.png'">
          <div class="movie-meta">
            <h3 class="movie-title">${escapeHtml(details.Title || title)} ${details.Year ? '('+escapeHtml(details.Year)+')' : ''}</h3>
            <p><strong>Σκηνοθέτης:</strong> ${escapeHtml(details.Director || '—')}</p>
            <p><strong>Είδος:</strong> ${escapeHtml(details.Genre || '—')}</p>
            <p><strong>IMDB:</strong> ${escapeHtml(details.imdbRating || '—')}</p>
            <p class="movie-plot">${escapeHtml(details.Plot || '')}</p>
          </div>
        </div>
      `;
    } else {
      li.innerHTML = `<div class="movie-card"><div class="movie-meta"><h3>${escapeHtml(title)}</h3><p class="error">Δεν βρέθηκαν στοιχεία.</p></div></div>`;
    }

    list.appendChild(li);
  });
} else {
  titlesDiv.innerHTML = "<strong>Ταινίες:</strong> —";
}

            } catch (err) {
                resultDiv.innerHTML = "<span class='error'>Σφάλμα επικοινωνίας με το API!</span>";
                console.error(err);
            }
        };

        (function updateFooterYear() {
          const y = new Date().getFullYear();
          const el = document.getElementById('year');
          if (el) el.textContent = y;
        })();
    </script>
</body>

</html>
